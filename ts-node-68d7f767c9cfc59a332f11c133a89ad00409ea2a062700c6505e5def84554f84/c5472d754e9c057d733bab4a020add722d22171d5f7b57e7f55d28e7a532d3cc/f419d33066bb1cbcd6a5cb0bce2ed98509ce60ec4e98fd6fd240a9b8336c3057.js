"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Created by hospogh on 7/29/17.
 */
var express = require("express");
var path_1 = require("path");
var fs_1 = require("fs");
var common_1 = require("./common");
var ordersFilePath = path_1.join(__dirname, 'data/orders.db.json');
// const booksFilePath = join(__dirname, 'data/books.db.json');
// const usersFilePath = join(__dirname, 'data/users.db.json');
var Order = (function () {
    function Order(data) {
        this.orderId = common_1.createGUID();
        Object.assign(this, data);
        var nowDate = new Date();
        var date = this.orderDate;
        var days = this.orderDays;
        this.orderDate = date && nowDate.valueOf() < date.valueOf() ? date : nowDate;
        this.orderDays = days && days > 0 ? days : 30;
    }
    Order.getOrder = function (orderId) {
        return Order.getAllOrders().find(function (o) { return o.orderId === orderId && o.orderId === orderId; });
    };
    Order.getOrderIndex = function (orderId) {
        return Order.getAllOrders().findIndex(function (o) { return o.orderId === orderId; });
    };
    Order.getAllOrders = function () {
        return JSON.parse(fs_1.readFileSync(ordersFilePath).toString());
    };
    Order.getUserOrders = function (userId) {
        return Order.getAllOrders().filter(function (o) { return o.userId === userId; });
    };
    Order.getBookOrders = function (bookId) {
        return Order.getAllOrders().filter(function (o) { return o.bookId === bookId; });
    };
    Order.saveAllOrders = function (ordersList) {
        fs_1.writeFileSync(ordersFilePath, JSON.stringify(ordersList, null, 2));
    };
    Order.createOrder = function (data) {
        var order = new Order(data);
        var orders = this.getAllOrders();
        orders.push(order);
        this.saveAllOrders(orders);
        return order;
    };
    Order.deleteOrder = function (orderId) {
        var orders = this.getAllOrders();
        var index = this.getOrderIndex(orderId);
        orders.splice(index, 1);
        this.saveAllOrders(orders);
    };
    Order.updateOrder = function (data) {
        var order = new Order(data);
        var orders = this.getAllOrders();
        var index = this.getOrderIndex(data.orderId);
        orders.splice(index, 1, order);
        this.saveAllOrders(orders);
        return data;
    };
    return Order;
}());
exports.Order = Order;
exports.OrderRouter = express.Router();
exports.OrderRouter.get('/order-list', function (req, res) {
    res.json(Order.getAllOrders());
});
exports.OrderRouter.get('/:orderId', function (req, res) {
    res.json(Order.getOrder(req.params.orderId));
});
// create order
exports.OrderRouter.post('/', function (req, res) {
    res.json(Order.createOrder(req.body));
});
// update order
exports.OrderRouter.post('/:orderId', function (req, res) {
    var data = req.body;
    data.orderId = req.prams.orderId;
    res.json(Order.updateOrder(data));
});
// delete order
exports.OrderRouter.delete('/:orderId', function (req, res) {
    res.json(Order.deleteOrder(res.params.orderId));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvaG9zcG9naC9EZXNrdG9wL2JldFByb2plY3RMaWJyYXJpdW0vbGlicmFyaXVtL3NyYy9zZXJ2ZXItYXBpL29yZGVyLnRzIiwic291cmNlcyI6WyIvaG9tZS9ob3Nwb2doL0Rlc2t0b3AvYmV0UHJvamVjdExpYnJhcml1bS9saWJyYXJpdW0vc3JjL3NlcnZlci1hcGkvb3JkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7R0FFRztBQUNILGlDQUFtQztBQUNuQyw2QkFBMEI7QUFDMUIseUJBQStDO0FBQy9DLG1DQUFvQztBQUVwQyxJQUFNLGNBQWMsR0FBRyxXQUFJLENBQUMsU0FBUyxFQUFFLHFCQUFxQixDQUFDLENBQUM7QUFDOUQsK0RBQStEO0FBQy9ELCtEQUErRDtBQUUvRDtJQU9FLGVBQVksSUFBSTtRQU5oQixZQUFPLEdBQVcsbUJBQVUsRUFBRSxDQUFDO1FBTzdCLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTFCLElBQU0sT0FBTyxHQUFTLElBQUksSUFBSSxFQUFFLENBQUM7UUFDakMsSUFBTSxJQUFJLEdBQVMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNsQyxJQUFNLElBQUksR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBRXBDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxHQUFHLE9BQU8sQ0FBQztRQUM3RSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUdNLGNBQVEsR0FBZixVQUFnQixPQUFPO1FBQ3JCLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLE9BQU8sS0FBSyxPQUFP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QUVILG1CQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxVQUFDLEdBQUcsRUFBRSxHQUFHO0lBQ3BDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDL0MsQ0FBQyxDQUFDLENBQUM7QUFFSCxlQUFlO0FBQ2YsbUJBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFVBQUMsR0FBRyxFQUFFLEdBQUc7SUFDN0IsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ3hDLENBQUMsQ0FBQyxDQUFDO0FBRUgsZUFBZTtBQUNmLG1CQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxVQUFDLEdBQUcsRUFBRSxHQUFHO0lBQ3JDLElBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDdEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztJQUNqQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUMsQ0FBQztBQUVILGVBQWU7QUFDZixtQkFBVyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsVUFBQyxHQUFHLEVBQUUsR0FBRztJQUN2QyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ2xELENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IGhvc3BvZ2ggb24gNy8yOS8xNy5cbiAqL1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7am9pbn0gZnJvbSAncGF0aCc7XG5pbXBvcnQge3JlYWRGaWxlU3luYywgd3JpdGVGaWxlU3luY30gZnJvbSAnZnMnO1xuaW1wb3J0IHtjcmVhdGVHVUlEfSBmcm9tICcuL2NvbW1vbic7XG5cbmNvbnN0IG9yZGVyc0ZpbGVQYXRoID0gam9pbihfX2Rpcm5hbWUsICdkYXRhL29yZGVycy5kYi5qc29uJyk7XG4vLyBjb25zdCBib29rc0ZpbGVQYXRoID0gam9pbihfX2Rpcm5hbWUsICdkYXRhL2Jvb2tzLmRiLmpzb24nKTtcbi8vIGNvbnN0IHVzZXJzRmlsZVBhdGggPSBqb2luKF9fZGlybmFtZSwgJ2RhdGEvdXNlcnMuZGIuanNvbicpO1xuXG5leHBvcnQgY2xhc3MgT3JkZXIge1xuICBvcmRlcklkOiBzdHJpbmcgPSBjcmVhdGVHVUlEKCk7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBib29rSWQ6IHN0cmluZztcbiAgb3JkZXJEYXRlOiBEYXRlO1xuICBvcmRlckRheXM6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihkYXRhKSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBkYXRhKTtcblxuICAgIGNvbnN0IG5vd0RhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGRhdGU6IERhdGUgPSB0aGlzLm9yZGVyRGF0ZTtcbiAgICBjb25zdCBkYXlzOiBudW1iZXIgPSB0aGlzLm9yZGVyRGF5cztcblxuICAgIHRoaXMub3JkZXJEYXRlID0gZGF0ZSAmJiBub3dEYXRlLnZhbHVlT2YoKSA8IGRhdGUudmFsdWVPZigpID8gZGF0ZSA6IG5vd0RhdGU7XG4gICAgdGhpcy5vcmRlckRheXMgPSBkYXlzICYmIGRheXMgPiAwID8gZGF5cyA6IDMwO1xuICB9XG5cblxuICBzdGF0aWMgZ2V0T3JkZXIob3JkZXJJZCkge1xuICAgIHJldHVybiBPcmRlci5nZXRBbGxPcmRlcnMoKS5maW5kKG8gPT4gby5vcmRlcklkID09PSBvcmRlcklkICYmIG8ub3JkZXJJZCA9PT0gb3JkZXJJZCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0T3JkZXJJbmRleChvcmRlcklkKSB7XG4gICAgcmV0dXJuIE9yZGVyLmdldEFsbE9yZGVycygpLmZpbmRJbmRleChvID0+IG8ub3JkZXJJZCA9PT0gb3JkZXJJZCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0QWxsT3JkZXJzKCk6IE9yZGVyW10ge1xuICAgIHJldHVybiBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhvcmRlcnNGaWxlUGF0aCkudG9TdHJpbmcoKSk7XG4gIH1cblxuICBzdGF0aWMgZ2V0VXNlck9yZGVycyh1c2VySWQpOiBPcmRlcltdIHtcbiAgICByZXR1cm4gT3JkZXIuZ2V0QWxsT3JkZXJzKCkuZmlsdGVyKG8gPT4gby51c2VySWQgPT09IHVzZXJJZCk7XG4gIH1cblxuICBzdGF0aWMgZ2V0Qm9va09yZGVycyhib29rSWQpOiBPcmRlcltdIHtcbiAgICByZXR1cm4gT3JkZXIuZ2V0QWxsT3JkZXJzKCkuZmlsdGVyKG8gPT4gby5ib29rSWQgPT09IGJvb2tJZCk7XG4gIH1cblxuICBzdGF0aWMgc2F2ZUFsbE9yZGVycyhvcmRlcnNMaXN0KSB7XG4gICAgd3JpdGVGaWxlU3luYyhvcmRlcnNGaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkob3JkZXJzTGlzdCwgbnVsbCwgMikpO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZU9yZGVyKGRhdGEpIHtcbiAgICBjb25zdCBvcmRlciA9IG5ldyBPcmRlcihkYXRhKTtcbiAgICBjb25zdCBvcmRlcnMgPSB0aGlzLmdldEFsbE9yZGVycygpO1xuICAgIG9yZGVycy5wdXNoKG9yZGVyKTtcbiAgICB0aGlzLnNhdmVBbGxPcmRlcnMob3JkZXJzKTtcbiAgICByZXR1cm4gb3JkZXI7XG4gIH1cblxuICBzdGF0aWMgZGVsZXRlT3JkZXIob3JkZXJJZCkge1xuICAgIGNvbnN0IG9yZGVycyA9IHRoaXMuZ2V0QWxsT3JkZXJzKCk7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldE9yZGVySW5kZXgob3JkZXJJZCk7XG4gICAgb3JkZXJzLnNwbGljZShpbmRleCwgMSk7XG4gICAgdGhpcy5zYXZlQWxsT3JkZXJzKG9yZGVycyk7XG4gIH1cblxuICBzdGF0aWMgdXBkYXRlT3JkZXIoZGF0YSkge1xuICAgIGNvbnN0IG9yZGVyID0gbmV3IE9yZGVyKGRhdGEpO1xuICAgIGNvbnN0IG9yZGVycyA9IHRoaXMuZ2V0QWxsT3JkZXJzKCk7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldE9yZGVySW5kZXgoZGF0YS5vcmRlcklkKTtcbiAgICBvcmRlcnMuc3BsaWNlKGluZGV4LCAxLCBvcmRlcik7XG4gICAgdGhpcy5zYXZlQWxsT3JkZXJzKG9yZGVycyk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IE9yZGVyUm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcblxuT3JkZXJSb3V0ZXIuZ2V0KCcvb3JkZXItbGlzdCcsIChyZXEsIHJlcykgPT4ge1xuICByZXMuanNvbihPcmRlci5nZXRBbGxPcmRlcnMoKSk7XG59KTtcblxuT3JkZXJSb3V0ZXIuZ2V0KCcvOm9yZGVySWQnLCAocmVxLCByZXMpID0+IHtcbiAgcmVzLmpzb24oT3JkZXIuZ2V0T3JkZXIocmVxLnBhcmFtcy5vcmRlcklkKSk7XG59KTtcblxuLy8gY3JlYXRlIG9yZGVyXG5PcmRlclJvdXRlci5wb3N0KCcvJywgKHJlcSwgcmVzKSA9PiB7XG4gIHJlcy5qc29uKE9yZGVyLmNyZWF0ZU9yZGVyKHJlcS5ib2R5KSk7XG59KTtcblxuLy8gdXBkYXRlIG9yZGVyXG5PcmRlclJvdXRlci5wb3N0KCcvOm9yZGVySWQnLCAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgZGF0YSA9IHJlcS5ib2R5O1xuICBkYXRhLm9yZGVySWQgPSByZXEucHJhbXMub3JkZXJJZDtcbiAgcmVzLmpzb24oT3JkZXIudXBkYXRlT3JkZXIoZGF0YSkpO1xufSk7XG5cbi8vIGRlbGV0ZSBvcmRlclxuT3JkZXJSb3V0ZXIuZGVsZXRlKCcvOm9yZGVySWQnLCAocmVxLCByZXMpID0+IHtcbiAgcmVzLmpzb24oT3JkZXIuZGVsZXRlT3JkZXIocmVzLnBhcmFtcy5vcmRlcklkKSk7XG59KTtcbiJdfQ==