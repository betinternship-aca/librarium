"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Created by hospogh on 7/29/17.
 */
var express = require("express");
var path_1 = require("path");
var fs_1 = require("fs");
var common_1 = require("./common");
var ordersFilePath = path_1.join(__dirname, 'data/orders.db.json');
// const booksFilePath = join(__dirname, 'data/books.db.json');
// const usersFilePath = join(__dirname, 'data/users.db.json');
var Order = (function () {
    function Order(_a) {
        var orderId = _a.orderId, userId = _a.userId, bookId = _a.bookId, orderDate = _a.orderDate, orderDays = _a.orderDays;
        this.orderId = common_1.createGUID();
        if (orderId) {
            this.orderId = orderId;
        }
        if (userId) {
            this.userId = userId;
        }
        if (bookId) {
            this.bookId = bookId;
        }
        var nowDate = new Date();
        this.orderDate = orderDate && nowDate.valueOf() < orderDate.valueOf() ? orderDate : nowDate;
        this.orderDays = orderDays && orderDays > 0 ? Number.parseInt(orderDays) : 30;
    }
    Order.getAllOrders = function () {
        return JSON.parse(fs_1.readFileSync(ordersFilePath).toString());
    };
    Order.getUserOrders = function (userId) {
        return Order.getAllOrders().filter(function (o) { return o.userId === userId; });
    };
    Order.getBookOrders = function (bookId) {
        return Order.getAllOrders().filter(function (o) { return o.bookId === bookId; });
    };
    Order.createOrder = function (data) {
        var order = new Order(data);
        var orders = this.getAllOrders();
        orders.push(order);
        this.saveAllOrders(orders);
        return order;
    };
    Order.updateOrder = function (order) {
        var orders = this.getAllOrders();
        var index = this.getOrderIndex(order.orderId);
        orders.splice(index, 1, order);
        this.saveAllOrders(orders);
        return order;
    };
    Order.deleteOrder = function (orderId) {
        var orders = this.getAllOrders();
        var index = this.getOrderIndex(orderId);
        orders.splice(index, 1);
        this.saveAllOrders(orders);
    };
    Order.saveAllOrders = function (ordersList) {
        fs_1.writeFileSync(ordersFilePath, JSON.stringify(ordersList, null, 2));
    };
    Order.getOrder = function (orderId) {
        return Order.getAllOrders().find(function (o) { return o.orderId === orderId; });
    };
    Order.getOrderIndex = function (orderId) {
        return Order.getAllOrders().findIndex(function (o) { return o.orderId === orderId; });
    };
    return Order;
}());
exports.Order = Order;
exports.OrderRouter = express.Router();
// get all orders
exports.OrderRouter.get('/order-list', function (req, res) { return res.json(Order.getAllOrders()); });
// get order
exports.OrderRouter.get('/:orderId', function (req, res) { return res.json(Order.getOrder(req.params.orderId)); });
// create order
// req.body --> server.ts   app.use(bodyParser.json()); // get from req.body wanted js object
exports.OrderRouter.post('/', function (req, res) { return res.json(Order.createOrder(req.body)); });
// update order
exports.OrderRouter.post('/:orderId', function (req, res) {
    var data = req.body;
    data.id = req.params.orderId;
    res.json(Order.updateOrder(data));
});
// delete order
exports.OrderRouter.delete('/:orderId', function (req, res) { return res.json(Order.deleteOrder(req.params.orderId)); });
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL2hvbWUvaG9zcG9naC9EZXNrdG9wL2JldFByb2plY3RMaWJyYXJpdW0vbGlicmFyaXVtL3NyYy9zZXJ2ZXItYXBpL29yZGVyLnRzIiwic291cmNlcyI6WyIvaG9tZS9ob3Nwb2doL0Rlc2t0b3AvYmV0UHJvamVjdExpYnJhcml1bS9saWJyYXJpdW0vc3JjL3NlcnZlci1hcGkvb3JkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7R0FFRztBQUNILGlDQUFtQztBQUNuQyw2QkFBMEI7QUFDMUIseUJBQStDO0FBQy9DLG1DQUFvQztBQUVwQyxJQUFNLGNBQWMsR0FBRyxXQUFJLENBQUMsU0FBUyxFQUFFLHFCQUFxQixDQUFDLENBQUM7QUFDOUQsK0RBQStEO0FBQy9ELCtEQUErRDtBQUUvRDtJQVFFLGVBQVksRUFBK0M7WUFBOUMsb0JBQU8sRUFBRSxrQkFBTSxFQUFFLGtCQUFNLEVBQUUsd0JBQVMsRUFBRSx3QkFBUztRQVAxRCxZQUFPLEdBQVcsbUJBQVUsRUFBRSxDQUFDO1FBUTdCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN6QixDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDdkIsQ0FBQztRQUVELElBQU0sT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxTQUFTLEdBQUcsT0FBTyxDQUFDO1FBRTVGLElBQUksQ0FBQyxTQUFTLEdBQUcs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K0MsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IGhvc3BvZ2ggb24gNy8yOS8xNy5cbiAqL1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCB7am9pbn0gZnJvbSAncGF0aCc7XG5pbXBvcnQge3JlYWRGaWxlU3luYywgd3JpdGVGaWxlU3luY30gZnJvbSAnZnMnO1xuaW1wb3J0IHtjcmVhdGVHVUlEfSBmcm9tICcuL2NvbW1vbic7XG5cbmNvbnN0IG9yZGVyc0ZpbGVQYXRoID0gam9pbihfX2Rpcm5hbWUsICdkYXRhL29yZGVycy5kYi5qc29uJyk7XG4vLyBjb25zdCBib29rc0ZpbGVQYXRoID0gam9pbihfX2Rpcm5hbWUsICdkYXRhL2Jvb2tzLmRiLmpzb24nKTtcbi8vIGNvbnN0IHVzZXJzRmlsZVBhdGggPSBqb2luKF9fZGlybmFtZSwgJ2RhdGEvdXNlcnMuZGIuanNvbicpO1xuXG5leHBvcnQgY2xhc3MgT3JkZXIge1xuICBvcmRlcklkOiBzdHJpbmcgPSBjcmVhdGVHVUlEKCk7XG4gIC8vIGxpYnJhcnlPcmRlciA7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBib29rSWQ6IHN0cmluZztcbiAgb3JkZXJEYXRlPzogRGF0ZTtcbiAgb3JkZXJEYXlzPzogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHtvcmRlcklkLCB1c2VySWQsIGJvb2tJZCwgb3JkZXJEYXRlLCBvcmRlckRheXN9KSB7XG4gICAgaWYgKG9yZGVySWQpIHtcbiAgICAgIHRoaXMub3JkZXJJZCA9IG9yZGVySWQ7XG4gICAgfVxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIHRoaXMudXNlcklkID0gdXNlcklkO1xuICAgIH1cbiAgICBpZiAoYm9va0lkKSB7XG4gICAgICB0aGlzLmJvb2tJZCA9IGJvb2tJZDtcbiAgICB9XG5cbiAgICBjb25zdCBub3dEYXRlID0gbmV3IERhdGUoKTtcbiAgICB0aGlzLm9yZGVyRGF0ZSA9IG9yZGVyRGF0ZSAmJiBub3dEYXRlLnZhbHVlT2YoKSA8IG9yZGVyRGF0ZS52YWx1ZU9mKCkgPyBvcmRlckRhdGUgOiBub3dEYXRlO1xuXG4gICAgdGhpcy5vcmRlckRheXMgPSBvcmRlckRheXMgJiYgb3JkZXJEYXlzID4gMCA/IE51bWJlci5wYXJzZUludChvcmRlckRheXMpIDogMzA7XG4gIH1cblxuXG4gIHN0YXRpYyBnZXRBbGxPcmRlcnMoKTogT3JkZXJbXSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKG9yZGVyc0ZpbGVQYXRoKS50b1N0cmluZygpKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRVc2VyT3JkZXJzKHVzZXJJZDogc3RyaW5nKTogT3JkZXJbXSB7XG4gICAgcmV0dXJuIE9yZGVyLmdldEFsbE9yZGVycygpLmZpbHRlcihvID0+IG8udXNlcklkID09PSB1c2VySWQpO1xuICB9XG5cbiAgc3RhdGljIGdldEJvb2tPcmRlcnMoYm9va0lkOiBzdHJpbmcpOiBPcmRlcltdIHtcbiAgICByZXR1cm4gT3JkZXIuZ2V0QWxsT3JkZXJzKCkuZmlsdGVyKG8gPT4gby5ib29rSWQgPT09IGJvb2tJZCk7XG4gIH1cblxuICBzdGF0aWMgY3JlYXRlT3JkZXIoZGF0YSkge1xuICAgIGNvbnN0IG9yZGVyID0gbmV3IE9yZGVyKGRhdGEpO1xuICAgIGNvbnN0IG9yZGVycyA9IHRoaXMuZ2V0QWxsT3JkZXJzKCk7XG4gICAgb3JkZXJzLnB1c2gob3JkZXIpO1xuICAgIHRoaXMuc2F2ZUFsbE9yZGVycyhvcmRlcnMpO1xuICAgIHJldHVybiBvcmRlcjtcbiAgfVxuXG4gIHN0YXRpYyB1cGRhdGVPcmRlcihvcmRlcikge1xuICAgIGNvbnN0IG9yZGVycyA9IHRoaXMuZ2V0QWxsT3JkZXJzKCk7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdldE9yZGVySW5kZXgob3JkZXIub3JkZXJJZCk7XG4gICAgb3JkZXJzLnNwbGljZShpbmRleCwgMSwgb3JkZXIpO1xuICAgIHRoaXMuc2F2ZUFsbE9yZGVycyhvcmRlcnMpO1xuICAgIHJldHVybiBvcmRlcjtcbiAgfVxuXG4gIHN0YXRpYyBkZWxldGVPcmRlcihvcmRlcklkKSB7XG4gICAgY29uc3Qgb3JkZXJzID0gdGhpcy5nZXRBbGxPcmRlcnMoKTtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ2V0T3JkZXJJbmRleChvcmRlcklkKTtcbiAgICBvcmRlcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB0aGlzLnNhdmVBbGxPcmRlcnMob3JkZXJzKTtcbiAgfVxuXG4gIHN0YXRpYyBzYXZlQWxsT3JkZXJzKG9yZGVyc0xpc3QpIHtcbiAgICB3cml0ZUZpbGVTeW5jKG9yZGVyc0ZpbGVQYXRoLCBKU09OLnN0cmluZ2lmeShvcmRlcnNMaXN0LCBudWxsLCAyKSk7XG4gIH1cblxuICBzdGF0aWMgZ2V0T3JkZXIob3JkZXJJZCkge1xuICAgIHJldHVybiBPcmRlci5nZXRBbGxPcmRlcnMoKS5maW5kKG8gPT4gby5vcmRlcklkID09PSBvcmRlcklkKTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRPcmRlckluZGV4KG9yZGVySWQpIHtcbiAgICByZXR1cm4gT3JkZXIuZ2V0QWxsT3JkZXJzKCkuZmluZEluZGV4KG8gPT4gby5vcmRlcklkID09PSBvcmRlcklkKTtcbiAgfVxufVxuXG5cbmV4cG9ydCBjb25zdCBPcmRlclJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbi8vIGdldCBhbGwgb3JkZXJzXG5PcmRlclJvdXRlci5nZXQoJy9vcmRlci1saXN0JywgKHJlcSwgcmVzKSA9PiByZXMuanNvbihPcmRlci5nZXRBbGxPcmRlcnMoKSkpO1xuXG4vLyBnZXQgb3JkZXJcbk9yZGVyUm91dGVyLmdldCgnLzpvcmRlcklkJywgKHJlcSwgcmVzKSA9PiByZXMuanNvbihPcmRlci5nZXRPcmRlcihyZXEucGFyYW1zLm9yZGVySWQpKSk7XG5cbi8vIGNyZWF0ZSBvcmRlclxuLy8gcmVxLmJvZHkgLS0+IHNlcnZlci50cyAgIGFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpOyAvLyBnZXQgZnJvbSByZXEuYm9keSB3YW50ZWQganMgb2JqZWN0XG5PcmRlclJvdXRlci5wb3N0KCcvJywgKHJlcSwgcmVzKSA9PiByZXMuanNvbihPcmRlci5jcmVhdGVPcmRlcihyZXEuYm9keSkpKTtcblxuLy8gdXBkYXRlIG9yZGVyXG5PcmRlclJvdXRlci5wb3N0KCcvOm9yZGVySWQnLCAocmVxLCByZXMpID0+IHtcbiAgY29uc3QgZGF0YSA9IHJlcS5ib2R5O1xuICBkYXRhLmlkID0gcmVxLnBhcmFtcy5vcmRlcklkO1xuICByZXMuanNvbihPcmRlci51cGRhdGVPcmRlcihkYXRhKSk7XG59KTtcblxuLy8gZGVsZXRlIG9yZGVyXG5PcmRlclJvdXRlci5kZWxldGUoJy86b3JkZXJJZCcsIChyZXEsIHJlcykgPT4gcmVzLmpzb24oT3JkZXIuZGVsZXRlT3JkZXIocmVxLnBhcmFtcy5vcmRlcklkKSkpO1xuXG4iXX0=